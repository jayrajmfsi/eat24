<?php
/**
 *  Address Repository
 *  @category Repository
 *  @author Jayraj Arora<jayraja@mindfiresolutions.com>
 */
namespace AppBundle\Repository;

use AppBundle\Entity\Address;
use Doctrine\ORM\EntityRepository;

/**
 * AddressRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class AddressRepository extends EntityRepository
{
    /**
     * List user address  which are active and having the user as provided
     * @param $customerId
     * @return array
     */
    public function listUserAddress($customerId)
    {
        $qb = $this->createQueryBuilder('address')
            ->select('address.completeAddress')
            ->addSelect('address.mapLocation as location')
            ->addSelect('address.token as addressCode')
            ->addSelect('address.nickName')
            ->where('address.customerId = :customerId')
            ->andWhere('address.addressType = :addressType')
            ->andWhere('address.isActive =:isActive')
            ->setParameters([
                'customerId' => $customerId,
                'addressType' => Address::CUSTOMER_ADDRESS,
                'isActive' => Address::ADDRESS_ACTIVE
            ])
        ;

        return $qb->getQuery()->getArrayResult();
    }

    /**
     * Fetch user address according to the address code provided
     * @param $customerId
     * @param $addressCode
     * @param string $addressType
     * @return mixed
     * @throws \Doctrine\ORM\NonUniqueResultException
     */
    public function getAddress($customerId, $addressCode, $addressType = Address::CUSTOMER_ADDRESS)
    {
        $qb = $this->createQueryBuilder('address')
            ->where('address.customerId = :customerId')
            ->andWhere('address.token = :token')
            ->andWhere('address.addressType = :type')
            ->setParameters(['token' => $addressCode, 'customerId' => $customerId, 'type' => $addressType])
        ;

        return $qb->getQuery()->getOneOrNullResult();
    }

    /**
     * Check distance of a geopoint with a particular restaurant
     * @param $geoPoint
     * @param $restaurantId
     * @param $range
     * @return array
     */
    public function checkDeliveryLocation($geoPoint, $restaurantId, $range)
    {
        $qb = $this->createQueryBuilder('address')
            ->where('address.customerId = :restaurantId')
            ->andWhere('address.addressType = :type')
            ->andWhere('ST_DISTANCE_SPHERE(address.geoPoint, POINT_STR(:point)) / 1000 <='. $range)
            ->setParameters([
                'restaurantId' => $restaurantId,
                'type' => Address::RESTAURANT_ADDRESS,
                'point' => $geoPoint
            ])
        ;

        return $qb->getQuery()->getArrayResult();
    }
}
